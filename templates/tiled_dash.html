<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiled Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #3a3a3a;
        }
        .page-header h1 {
            font-size: 1.8em;
            color: #ffffff;
            margin: 0;
        }
        .group-title {
            font-size: 1.4em;
            color: #f0f0f0;
            margin-top: 25px;
            margin-bottom: 12px;
            padding-bottom: 5px;
            border-bottom: 2px solid #3a3a3a;
        }
        .tile-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(290px, 1fr));
            gap: 10px;
        }
        .tile {
            display: flex;
            align-items: center;
            background-color: #2c2c2c;
            border: 1px solid #444444;
            border-radius: 6px;
            padding: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
            transition: box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .tile:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.6);
            border-color: #58a6ff;
        }
        .tile-icon {
            flex-shrink: 0;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        .tile-icon img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 4px;
        }
        .icon-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background-color: #3d3d3d;
            border-radius: 4px;
            font-size: 18px;
            color: #9e9e9e;
        }
        .tile-details {
            flex-grow: 1;
            margin-right: 8px;
            overflow: hidden;
        }
        .container-name {
            font-weight: 600;
            color: #f5f5f5;
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.95em;
        }
        .host-name {
            font-size: 0.75em;
            color: #a0a0a0;
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .tile-statuses {
            display: flex;
            align-items: center;
        }
        .tile-web-statuses {
            margin-right: 6px;
            width: 36px;
        }
        .status-button {
            display: inline-block;
            vertical-align: middle;
            border: none;
            border-radius: 4px;
            color: white;
            text-decoration: none;
            text-align: center;
            transition: opacity 0.2s;
            font-weight: 500;
            box-sizing: border-box;
        }
        .status-button:hover {
            opacity: 0.85;
        }
        .tile-web-statuses .status-button {
            display: block;
            width: 100%;
            padding: 3px 0;
            font-size: 9px;
            line-height: 1.2;
            margin-bottom: 2px;
        }
        .tile-web-statuses .status-button:last-child {
            margin-bottom: 0;
        }
        .docker-status-button {
            padding: 3px 7px;
            font-size: 0.7em;
            min-width: 55px;
        }
        .dozzle-direct-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            line-height: 0;
        }
        .dozzle-icon-img {
            width: 18px;
            height: 18px;
            opacity: 0.65;
            transition: opacity 0.2s ease-in-out;
        }
        .dozzle-direct-link:hover .dozzle-icon-img {
            opacity: 1;
        }
        .status-button-good { background-color: #2ecc71; }
        .status-button-bad { background-color: #e74c3c; }
        .status-button-unknown { background-color: #7f8c8d; }
        .status-button-stale { background-color: #f39c12; color: #fff; }
    </style>
</head>
<body>
    <div class="flex justify-end gap-2 mb-4">
        <a href="/add" class="border border-gray-500 text-gray-300 text-sm px-2 py-0.5 rounded hover:bg-gray-600 hover:text-white transition">Add Record</a>
        <a href="/" class="border border-gray-500 text-gray-300 text-sm px-2 py-0.5 rounded hover:bg-gray-600 hover:text-white transition">Dashboard</a>
        <a href="/settings" class="border border-gray-500 text-gray-300 text-sm px-2 py-0.5 rounded hover:bg-gray-600 hover:text-white transition">Settings</a>
    </div>
    <div class="page-header">
        <h1>Tiled Dashboard</h1>
    </div>


    <div class="controls-container">
        <div class="grouping-controls">
            <label for="groupBySelect">Group by:</label>
            <select id="groupBySelect">
                <option value="group_name">Group Name</option>
                <option value="host">Docker Host</option>
                  <option value="stack_name">Stack Name</option>
                </select>
        </div>
        </div>

    {% if grouped_entries %}
        {% for group_name, entries_in_group in grouped_entries.items() %}
            <h2 class="group-title">{{ group_name }}</h2>
            <div class="tile-container">
                {% for entry in entries_in_group %}
                    <div class="tile"
                        data-internalurl="{{ entry.internalurl if entry.internalurl else '' }}"
                        data-externalurl="{{ entry.externalurl if entry.externalurl else '' }}">
                        <div class="tile-icon">
                            {% if entry.image_icon %}
                                <img src="{{ url_for('serve_image', filename=entry.image_icon) }}"
                                     alt="{{ entry.container_name }} icon"
                                     onerror="this.style.display='none'; this.parentElement.innerHTML = '<span class=\'icon-placeholder\'>ðŸš«</span>';">
                            {% else %}
                                <span class="icon-placeholder">ðŸ“¦</span>
                            {% endif %}
                        </div>
                        <div class="tile-details">
                            <strong class="container-name" title="{{ entry.container_name }}">{{ entry.container_name }}</strong>
                            <small class="host-name" title="{{ entry.host }}">{{ entry.host }}</small>
                        </div>
                        <div class="tile-statuses">
                            <div class="tile-web-statuses">
                                {% if entry.internalurl and entry.internal_health_check_enabled %}
                                    <a href="{{ entry.internalurl }}" target="_blank"
                                       class="status-button {{ 'status-button-good' if entry.internal_health_check_status == '200' else 'status-button-bad' if entry.internal_health_check_status else 'status-button-unknown' }}"
                                       title="Internal: {{ entry.internal_health_check_status or 'N/A' }} ({{ entry.internal_health_check_update | time_since }})">
                                       INT
                                    </a>
                                {% endif %}
                                {% if entry.externalurl and entry.external_health_check_enabled %}
                                    <a href="{{ entry.externalurl }}" target="_blank"
                                       class="status-button {{ 'status-button-good' if entry.external_health_check_status == '200' else 'status-button-bad' if entry.external_health_check_status else 'status-button-unknown' }}"
                                       title="External: {{ entry.external_health_check_status or 'N/A' }} ({{ entry.external_health_check_update | time_since }})">
                                       EXT
                                    </a>
                                {% endif %}
                            </div>
                            <div class="tile-docker-status">
                                {% set docker_link = (STD_DOZZLE_URL + "/#/?filter=" + entry.container_name if STD_DOZZLE_URL and entry.container_name else "#") %}
                                {% set docker_status_lower = entry.docker_status.lower() if entry.docker_status else 'unknown' %}
                                
                                {% set _is_good_docker = ('running' in docker_status_lower and 'unhealthy' not in docker_status_lower) or 'healthy' in docker_status_lower %}
                                {% set _is_bad_docker = 'exited' in docker_status_lower or 'dead' in docker_status_lower or 'unhealthy' in docker_status_lower or 'restarting' in docker_status_lower or 'removing' in docker_status_lower or 'paused' in docker_status_lower %}

                                {% set docker_class = 'status-button-stale' if entry.is_docker_status_stale else
                                                    'status-button-good' if _is_good_docker else
                                                    'status-button-bad' if _is_bad_docker else
                                                    'status-button-unknown' %}
                                
                                {% set display_docker_status = (entry.docker_status.split('(')[0].strip() if entry.docker_status else 'N/A') %}

                                <a href="{{ docker_link }}" target="_blank"
                                   class="status-button docker-status-button {{ docker_class }}"
                                   title="Docker: {{ entry.docker_status or 'N/A' }}{% if entry.last_api_update %} ({{ entry.last_api_update | time_since }}){% endif %}">
                                    {{ display_docker_status[:9] }}{{ 'â€¦' if display_docker_status|length > 9 else '' }}
                                </a>
                            </div>
                            {% if STD_DOZZLE_URL and entry.container_id and entry.container_id|length > 0 %}
                            <a href="{{ STD_DOZZLE_URL }}/container/{{ entry.container_id[:12] }}"
                               target="_blank"
                               class="dozzle-direct-link"
                               title="Open Logs in Dozzle ({{ entry.container_id[:12] }})">
                                <img src="{{ url_for('static', filename='dozzle.svg')  }}" 
                                     alt="Dozzle Logs"
                                     class="dozzle-icon-img">
                            </a>
                        {% endif %}
                        </div>


                        
                    </div>
                {% else %}
                    <p>No entries in this group.</p> {% endfor %}
            </div>
        {% endfor %}
    {% else %}
        <p style="text-align: center; margin-top: 30px;">No service entries found or no groups to display based on current selection.</p>
    {% endif %}

<script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Logic for Grouping Dropdown ---
            const groupBySelect = document.getElementById('groupBySelect');
            const currentUrlParamsForGrouping = new URLSearchParams(window.location.search); // Renamed to avoid conflict
            
            const activeGroupBy = currentUrlParamsForGrouping.get('group_by') || 'group_name'; 

            if (groupBySelect) {
                groupBySelect.value = activeGroupBy; 

                groupBySelect.addEventListener('change', function() {
                    const selectedGroupBy = this.value;
                    const existingParamsForGrouping = new URLSearchParams(window.location.search); // Renamed
                    existingParamsForGrouping.set('group_by', selectedGroupBy);
                    window.location.search = existingParamsForGrouping.toString(); 
                });
            }

            // --- Logic for Making Tiles Clickable ---
            const tiles = document.querySelectorAll('.tile');
            tiles.forEach(tile => {
                const internalUrl = tile.dataset.internalurl; // Assumes you've added data-internalurl to your .tile divs
                const externalUrl = tile.dataset.externalurl; // Assumes you've added data-externalurl to your .tile divs

                // Only make the tile appear clickable and add a listener if there's a URL
                if (internalUrl || externalUrl) {
                    tile.style.cursor = 'pointer'; // Change cursor to indicate clickability

                    tile.addEventListener('click', function(event) {
                        // IMPORTANT: Check if the click was on an existing button inside the tile.
                        // If so, let the button's own click event handle it and do nothing here.
                        if (event.target.closest('a.status-button') || event.target.closest('a.dozzle-direct-link')) {
                            return; 
                        }

                        // Proceed with tile click action
                        if (internalUrl) {
                            window.open(internalUrl, '_blank'); // Open in a new tab
                        } else if (externalUrl) {
                            // This 'else if' ensures externalUrl is only tried if internalUrl is not present or empty
                            window.open(externalUrl, '_blank'); // Open in a new tab
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>