<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Service Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <style>
    .logo-icon {
      height: 40px;
      max-width: 40px;
      filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.5));
      transition: transform 0.2s ease-in-out;
    }
    .logo-icon:hover {
      transform: scale(1.1);
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen px-4 py-8 font-sans">
  <div class="max-w-7xl mx-auto">
    <div class="flex justify-end gap-2 mb-6">
      <a href="/add" class="border border-gray-500 text-gray-300 text-sm px-2 py-0.5 rounded hover:bg-gray-600 hover:text-white transition">Add Record</a>
      <a href="/tiled_dash" class="border border-gray-500 text-gray-300 text-sm px-2 py-0.5 rounded hover:bg-gray-600 hover:text-white transition">Tile View</a>
      <a href="/settings" class="border border-gray-500 text-gray-300 text-sm px-2 py-0.5 rounded hover:bg-gray-600 hover:text-white transition">Settings</a>
    </div>

    <div class="flex flex-wrap gap-4 mb-4 items-center">
      <input id="filterInput" type="text" placeholder="Filter by Group, Container, or Stack" class="bg-gray-800 border border-gray-600 px-3 py-1 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 flex-grow sm:flex-none" />
      <select id="groupBySelect" class="bg-gray-800 border border-gray-600 px-3 py-1 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
        <option value="group_name" {% if group_by == 'group_name' %}selected{% endif %}>Group</option>
        <option value="stack_name" {% if group_by == 'stack_name' %}selected{% endif %}>Stack</option>
        <option value="host" {% if group_by == 'host' %}selected{% endif %}>Host</option>
        <option value="is_static" {% if group_by == 'is_static' %}selected{% endif %}>Static</option>
      </select>
      <div id="refreshTimer" class="text-sm text-gray-400 cursor-pointer" onclick="window.location.reload()">Refreshed just now</div>
    </div>

    {% if msg == 'deleted' %}
      <div class="bg-red-700 text-white px-4 py-2 rounded mb-4">Entry deleted successfully.</div>
    {% elif msg == 'added' %}
      <div class="bg-green-700 text-white px-4 py-2 rounded mb-4">Entry added successfully.</div>
    {% endif %}

    <div class="overflow-x-auto">
      <table class="min-w-full table-auto text-sm text-left border-collapse">
        <thead class="bg-gray-700 text-gray-200">
          <tr>
            <th class="px-3 py-2">Logo</th>
            <th class="px-3 py-2">Group</th>
            <th class="px-3 py-2">Container</th>
            <th class="px-3 py-2">Stack</th>
            <th class="px-3 py-2">Host</th>
            <th class="px-3 py-2">Internal</th>
            <th class="px-3 py-2">External</th>
            <th class="px-3 py-2">Last Update</th>
            <th class="px-3 py-2">Status</th>
            <th class="px-3 py-2">Tools</th>
            <th class="px-3 py-2">Actions</th>
          </tr>
        </thead>
        {% for group, group_entries in grouped_entries.items() %}
        <tbody>
          <tr class="bg-gray-800 font-semibold">
            <td colspan="11" class="px-4 py-2">{{ group }}</td>
          </tr>
        </tbody>
        <tbody>
          {% for entry in group_entries %}
          <tr class="border-b border-gray-700" data-entry data-group="{{ entry.group_name }}" data-container="{{ entry.container_name }}" data-stack="{{ entry.stack_name }}">
            <td class="px-3 py-2">
              {% if entry.image_icon %}
                {% set target_url = entry.internalurl or entry.externalurl %}
                {% if target_url %}
                  <a href="{{ target_url }}" target="_blank"><img src="{{ url_for('serve_image', filename=entry.image_icon) }}" class="logo-icon" alt="Logo" /></a>
                {% else %}
                  <img src="{{ url_for('serve_image', filename=entry.image_icon) }}" class="logo-icon" alt="Logo" />
                {% endif %}
              {% endif %}
            </td>
            <td class="px-3 py-2">{{ entry.group_name }}</td>
            <td class="px-3 py-2">
              <div>{{ entry.container_name }}</div>
              {% if entry.container_id %}
              <div class="text-xs text-gray-400 cursor-pointer" onclick="copyToClipboard('{{ entry.container_id }}', this)" title="Click to copy full ID">
                <code>{{ entry.container_id[:12] }}</code>
              </div>
              {% endif %}
            </td>
            <td class="px-3 py-2">{{ entry.stack_name or '' }}</td>
            <td class="px-3 py-2">{{ entry.host }}</td>
            <td class="px-3 py-2">
              {% if entry.internalurl %}
                {% set status_class = 'bg-gray-600' %}
                {% set tooltip = 'Not Monitored' %}
                {% set display = 'NA' %}
                {% if entry.internal_health_check_enabled %}
                  {% set status_class = 'bg-green-600' if entry.internal_health_check_status and entry.internal_health_check_status.isdigit() and entry.internal_health_check_status|int < 400 else 'bg-red-600' %}
                  {% set tooltip = (entry.internal_health_check_status or '?') ~ ' â€” updated ' ~ (entry.internal_health_check_update|time_since) %}
                  {% set display = entry.internal_health_check_status or '?' %}
                {% endif %}
                <div class="flex items-center gap-2">
                  <span class="px-2 py-0.5 rounded text-xs font-medium {{ status_class }}" title="{{ tooltip }}">{{ display }}</span>
                  <a href="{{ entry.internalurl }}" target="_blank" class="border border-blue-400 text-blue-300 text-xs px-2 py-0.5 rounded hover:bg-blue-400 hover:text-white transition">Internal</a>
                </div>
              {% endif %}
            </td>
            <td class="px-3 py-2">
              {% if entry.externalurl %}
                {% set status_class = 'bg-gray-600' %}
                {% set tooltip = 'Not Monitored' %}
                {% set display = 'NA' %}
                {% if entry.external_health_check_enabled %}
                  {% set status_class = 'bg-green-600' if entry.external_health_check_status and entry.external_health_check_status.isdigit() and entry.external_health_check_status|int < 400 else 'bg-red-600' %}
                  {% set tooltip = (entry.external_health_check_status or '?') ~ ' â€” updated ' ~ (entry.external_health_check_update|time_since) %}
                  {% set display = entry.external_health_check_status or '?' %}
                {% endif %}
                <div class="flex items-center gap-2">
                  <span class="px-2 py-0.5 rounded text-xs font-medium {{ status_class }}" title="{{ tooltip }}">{{ display }}</span>
                  <a href="{{ entry.externalurl }}" target="_blank" class="border border-green-400 text-green-300 text-xs px-2 py-0.5 rounded hover:bg-green-400 hover:text-white transition">External</a>
                </div>
              {% endif %}
            </td>
            <td class="px-3 py-2">{{ entry.last_updated|time_since }}</td>
            <td class="px-3 py-2">
              {% set tooltip = entry.last_api_update | time_since if entry.last_api_update else 'Never updated' %}
              {% set timestamp = entry.last_api_update if entry.last_api_update else '' %}
              {% if entry.docker_status in ['start', 'running'] %}
                <span class="bg-green-600 px-2 py-0.5 rounded text-xs font-medium" title="Updated {{ tooltip }} â€” {{ timestamp }}">Running</span>
              {% elif entry.docker_status in ['die', 'exited'] %}
                <span class="bg-red-600 px-2 py-0.5 rounded text-xs font-medium" title="Updated {{ tooltip }} â€” {{ timestamp }}">Exited</span>
              {% elif entry.docker_status %}
                <span class="bg-yellow-400 text-black px-2 py-0.5 rounded text-xs font-medium" title="Updated {{ tooltip }} â€” {{ timestamp }}">{{ entry.docker_status }}</span>
              {% else %}
                <span class="bg-gray-600 px-2 py-0.5 rounded text-xs font-medium" title="Updated {{ tooltip }} â€” {{ timestamp }}">Unknown</span>
              {% endif %}
              {% if entry.image_tag %}
                <div class="text-xs text-gray-400 mt-1">Tag: <code>{{ entry.image_tag }}</code></div>
              {% endif %}
            </td>
            <td class="px-3 py-2">
              {% if STD_DOZZLE_URL and entry.container_id %}
                <a href="{{ STD_DOZZLE_URL }}/container/{{ entry.container_id[:12] }}" target="_blank">
                  <img src="{{ url_for('static', filename='dozzle.svg') }}" alt="Dozzle" class="h-5" />
                </a>
              {% endif %}
            </td>
            <td class="px-3 py-2">
              <a href="{{ url_for('edit_entry', id=entry.id, ref=request.full_path) }}" class="border border-yellow-400 text-yellow-300 text-xs px-2 py-0.5 rounded hover:bg-yellow-400 hover:text-black transition">Edit</a>
              {% if entry.is_static %}
                <span title="Static entry â€” API updates blocked" class="ml-2">ðŸ”’</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
        {% endfor %}
      </table>
    </div>
  </div>

  <script>
    let secondsSinceRefresh = 0;
    document.addEventListener('DOMContentLoaded', function () {
      const filterInput = document.getElementById('filterInput');
      const refreshLabel = document.getElementById('refreshTimer');
      const rows = document.querySelectorAll('table tbody tr[data-entry]');

      filterInput.addEventListener('input', function () {
        const filter = this.value.toLowerCase();
        rows.forEach(row => {
          const group = row.dataset.group.toLowerCase();
          const name = row.dataset.container.toLowerCase();
          const stack = row.dataset.stack.toLowerCase();
          row.style.display = (group.includes(filter) || name.includes(filter) || stack.includes(filter)) ? '' : 'none';
        });
      });

      setInterval(() => {
        secondsSinceRefresh++;
        if (refreshLabel) {
          const m = Math.floor(secondsSinceRefresh / 60);
          const s = secondsSinceRefresh % 60;
          refreshLabel.textContent = `Refreshed ${m > 0 ? m + 'm ' : ''}${s}s ago`;
        }
      }, 1000);

      document.getElementById("groupBySelect").addEventListener("change", function () {
        const selected = this.value;
        const params = new URLSearchParams(window.location.search);
        params.set("group_by", selected);
        window.location.search = params.toString();
      });
    });

    function copyToClipboard(text, el) {
      navigator.clipboard.writeText(text).then(() => {
        const original = el.innerHTML;
        el.innerHTML = "<em>Copied!</em>";
        setTimeout(() => el.innerHTML = original, 1000);
      });
    }
  </script>
</body>
</html>
